# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 21.3

[[toc]]

## æ¦‚è¦

SanicãŒé€Ÿããªã‚Šã¾ã—ãŸã€‚

ã¾ã‚ã€ã™ã§ã«é€Ÿã‹ã£ãŸã‚“ã§ã™ã‘ã©ã­ã€‚ã—ã‹ã—ã€v21ãƒªãƒªãƒ¼ã‚¹ã®æœ€åˆã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ã„ãã¤ã‹ã®ä¸»è¦ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’å–ã‚Šå…¥ã‚Œã€ç›®ã«è¦‹ãˆã‚‹æ”¹å–„ã‚’è¡Œã„ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã¯ã€ä½•å¹´ã‚‚å‰ã‹ã‚‰æ¸©ã‚ã¦ã„ãŸã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã€ã‚ˆã†ã‚„ããƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å–ã‚Šå…¥ã‚ŒãŸã‚‚ã®ã§ã™ã€‚

::: warning Breaking changes
ãƒãƒ¼ã‚¸ãƒ§ãƒ³21.3ã§ã¯ã€å¤šãã®æ–°æ©Ÿèƒ½ãŒå°å…¥ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ã„ãã¤ã‹ã®ç ´å£Šçš„ãªå¤‰æ›´ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãŸã‚ã€ã“ã‚Œã‚‰ã®å¤‰æ›´ã¯å‰å›ã®LTSã®å¾Œã«å°å…¥ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã—ã€å‰Šé™¤ã•ã‚ŒãŸã‚‚ã®ã«ä¾å­˜ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ v20.12LTS ã‚’ä½¿ã„ç¶šã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
pip install "sanic>=20.12,<20.13"
pip freeze > requirements.txt
```

ã»ã¨ã‚“ã©ã®å…¸å‹çš„ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã¯ã€å•é¡Œãªãã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã‚‹ã¯ãšã§ã™ã€‚
:::

## çŸ¥ã£ã¦ãŠããŸã„ã“ã¨

æ³¨ç›®ã®æ–°æ©Ÿèƒ½ãƒ»ä¸å…·åˆã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¯¾è±¡...

### Python 3.7ä»¥ä¸Šå¿…é ˆ

ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§Python 3.6ã®ã‚µãƒãƒ¼ãƒˆãŒçµ‚äº†ã—ã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 20.12LTS ã¯ 2022 å¹´ 12 æœˆã® EOL ã¾ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 19.12LTS ã¯ 2021 å¹´ 12 æœˆã® EOL ã¾ã§ Python 3.6 ã®ã‚µãƒãƒ¼ãƒˆã‚’ç¶™ç¶šã—ã¾ã™ã€‚

[LTSãƒãƒªã‚·ãƒ¼](../project/policies.md#long-term-support-v-interim-releases)ã«ã¤ã„ã¦ã‚‚ã£ã¨èª­ã‚€ã€‚

### ä¸€ç´šå¸‚æ°‘ã¨ã—ã¦ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

æœ€ã‚‚å¤§ããªé€Ÿåº¦å‘ä¸Šã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’1ã¤ã®ãƒ•ãƒ­ãƒ¼ã«çµ±ä¸€ã—ãŸã“ã¨ã§ã™ã€‚ä»¥å‰ã¯ã€é€šå¸¸ã®ã‚µã‚¤ã‚¯ãƒ«ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«ã®é–“ã«é•ã„ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯ã€äº’æ›æ€§ã®ãŸã‚ã«APIã¯åŒã˜ã¾ã¾ã§ã™ãŒã€ãƒ•ãƒ¼ãƒ‰ã®ä¸‹ã§ç°¡ç´ åŒ–ã•ã‚Œã¾ã—ãŸã€‚æ­£å‘³ã®åˆ©ç‚¹ã¯ã€**ã™ã¹ã¦ã®** ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ–°ã—ã„åˆ©ç‚¹ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã§ã™ã€‚

[ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®å¤‰æ›´](../advanced/streaming.md#response-streaming)ã«ã¤ã„ã¦ã‚‚ã£ã¨èª­ã‚€ã€‚

### ãƒ«ãƒ¼ã‚¿ãƒ¼ã®è¦‹ç›´ã—

å¤ã„Sanicã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯æ­£è¦è¡¨ç¾ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã¾ã—ãŸã€‚ã•ã‚‰ã«ã€ãã‚Œã¯å®Ÿè¡Œæ™‚ã«ä¿®æ­£ã™ã‚‹ã®ãŒé›£ã—ãã€ã„ãã¤ã‹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã‚’ã‚‚ãŸã‚‰ã—ãŸå¤šãã®ç™–ã«æ‚©ã¾ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ã“ã®å¤‰æ›´ã¯ä½•å¹´ã‚‚ã‹ã‘ã¦è¡Œã‚ã‚Œã€ç¾åœ¨ã§ã¯ [èµ·å‹•æ™‚ã«ãƒ«ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ„ãƒªãƒ¼ã«å¤‰æ›ã™ã‚‹](https://community.sanicframework.org/t/a-fast-new-router/649/41)ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ä»Šå¹´ä¸­ã®ã•ã‚‰ãªã‚‹æ”¹è‰¯ã«ã”æœŸå¾…ãã ã•ã„ã€‚

å¤–å‘ãã®APIã¯å¾Œæ–¹äº’æ›æ€§ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ç‰¹ã«ãƒ«ãƒ¼ã‚¿ãƒ¼å†…éƒ¨ã®ä½•ã‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ãŸå ´åˆã€ã„ãã¤ã‹ã®å¤‰æ›´ã«æ°—ã¥ãã“ã¨ãŒå¤šã„ã§ã—ã‚‡ã†ã€‚ä¾‹ãˆã°

1. 1. `Router.get()` ã«æ–°ã—ã„æˆ»ã‚Šå€¤ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
2. ãƒ«ãƒ¼ãƒˆ`ã¯ã€`namedtuple`ã§ã¯ãªãã€ã¡ã‚ƒã‚“ã¨ã—ãŸã‚¯ãƒ©ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã‚Šã¾ã—ãŸã€‚
3. ãƒ«ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§æ§‹ç¯‰ã™ã‚‹å ´åˆã€ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹å‰ã« `Router.finalize()` ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
4. 4. ãƒ«ãƒ¼ãƒˆã«ãƒãƒƒãƒã™ã‚‹æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ `<date:ymd>` ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
5. å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ«ãƒ¼ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯ç‹¬è‡ªã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚[sanic-org/sanic-router](https://github.com/sanic-org/sanic-router) ã¾ãŸã€ç‹¬è‡ªã® [standalone package on PyPI](https://pypi.org/project/sanic-routing/) ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚·ã‚°ãƒŠãƒ«API â­ï¸

_BETAæ©Ÿèƒ½: APIã¯v21.6ã§å®Œæˆäºˆå®šã§ã™_ã€‚

æ–°ã—ã„ãƒ«ãƒ¼ã‚¿ãƒ¼ã®å‰¯æ¬¡çš„ãªåˆ©ç‚¹ã¯ã€ãã‚ŒãŒ[æ–°ã—ã„ã‚·ã‚°ãƒŠãƒ«API](https://github.com/sanic-org/sanic/issues/1630)ã‚’ã‚‚å‹•ã‹ã™äºŒé‡ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ã§ã™ã€‚ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨å…¬é–‹ã•ã‚Œã¦ãŠã‚Šã€ãŠãã‚‰ãå…¬é–‹ã•ã‚Œã‚‹APIã¯æœ€çµ‚çš„ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã¯ãªã„ã§ã—ã‚‡ã†ã€‚

ã“ã®æ©Ÿèƒ½ã®æ ¸ã¨ãªã‚‹è€ƒãˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. é–‹ç™ºè€…ãŒã‚µãƒ¼ãƒãƒ¼ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®ã€ã‚ˆã‚Šå¤§ããªåˆ¶å¾¡ã¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã€‚
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åŒæœŸã•ã›ã€é€ä¿¡ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’æä¾›ã™ã‚‹ã“ã¨ã€ãŠã‚ˆã³
3. æœ€çµ‚çš„ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ã•ã‚‰ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ã€‚

ã“ã®APIã§ã¯ã€3ã¤ã®æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚

- `@app.signal(...)` - ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ«ãƒ¼ãƒˆã«éå¸¸ã«ã‚ˆãä¼¼ãŸå¤–è¦³ã¨å‹•ä½œã‚’ã—ã¾ã™ã€‚ã‚·ã‚°ãƒŠãƒ«ãŒãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã•ã‚Œã‚‹ãŸã³ã«ã€ã“ã®ãƒãƒ³ãƒ‰ãƒ©ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
- `app.event(...)` - ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹ã¾ã§å®Ÿè¡Œã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹ãŸã‚ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»»æ„ã®å ´æ‰€ã§ä½¿ç”¨ã§ãã‚‹å¾…ã¡å—ã‘ã§ã™ã€‚
- `app.dispatch(...)` - ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ã€ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ã‚’å®Ÿè¡Œã•ã›ã¾ã™ã€‚

```python
@app.signal("foo.bar.<thing>")
async def signal_handler(thing, **kwargs):
    print(f"[signal_handler] {thing=}", kwargs)

async def wait_for_event(app):
    while True:
        print("> waiting")
        await app.event("foo.bar.*")
        print("> event found\n")

@app.after_server_start
async def after_server_start(app, loop):
    app.add_task(wait_for_event(app))

@app.get("/")
async def trigger(request):
    await app.dispatch("foo.bar.baz")
    return response.text("Done.")
```

### Route naming

Routes used to be referenced by both `route.name` and `route.endpoint`. While similar, they were slightly different. Now, all routes will be **consistently** namespaced and referenced.

```
<app name>.[optional:<blueprint name>.]<handler name>
```

This new "name" is assigned to the property `route.name`. We are deprecating `route.endpoint`, and will remove that property in v21.9. Until then, it will be an alias for `route.name`.

In addition, naming prefixes that had been in use for things like static, websocket, and blueprint routes have been removed.

### New decorators

Several new convenience decorators to help IDEs with autocomplete.

```python
# Alias to @app.listener("...")
@app.before_server_start
@app.after_server_stop
@app.before_server_start
@app.after_server_stop

# Alias to @app.middleware("...")
@app.on_request
@app.on_response
```

### Unquote in route

If you have a route that uses non-ascii characters, Sanic will no longer `unquote` the text for you. You will need to specifically tell the route definition that it should do so.

```python
@app.route("/overload/<param>", methods=["GET"], unquote=True)
async def handler2(request, param):
    return text("OK2 " + param)

request, response = app.test_client.get("/overload/æ‚¨å¥½")
assert response.text == "OK2 æ‚¨å¥½"
```

If you forget to do so, your text will remain encoded.

### Alter `Request.match_info`

The `match_info` has always provided the data for the matched path parameters. You now have access to modify that, for example in middleware.

```python
@app.on_request
def convert_to_snake_case(request):
    request.match_info = to_snake(request.match_info)
```

### Version types in routes

The `version` argument in routes can now be:

- `str`
- `int`
- `float`

```python
@app.route("/foo", version="2.1.1")
@app.route("/foo", version=2)
@app.route("/foo", version=2.1)
```
### Safe method handling with body

Route handlers for `GET`, `HEAD`, `OPTIONS` and `DELETE` will not decode any HTTP body passed to it. You can override this:

```python
@app.delete(..., ignore_body=False)
```

### Application, Blueprint and Blueprint Group parity

The `Sanic` and `Blueprint` classes share a common base. Previously they duplicated a lot of functionality, that lead to slightly different implementations between them. Now that they both inherit the same base class, developers and plugins should have a more consistent API to work with.

Also, Blueprint Groups now also support common URL extensions like the `version` and `strict_slashes` keyword arguments.

### Dropped `httpx` from dependencies

There is no longer a dependency on `httpx`.

### Removed `testing` library

Sanic internal testing client has been removed. It is now located in its own repository: [sanic-org/sanic-testing](https://github.com/sanic-org/sanic-testing) and is also its own [standalone package on PyPI](https://pypi.org/project/sanic-testing/).

If you have `sanic-testing` installed, it will be available and usable on your `Sanic()` application instances as before. So, the **only** change you will need to make is to add `sanic-testing` to your test suite requirements.

### Application and connection level context (`ctx`) objects

Version 19.9 [added ](https://github.com/sanic-org/sanic/pull/1666/files) the `request.ctx` API. This helpful construct easily allows for attaching properties and data to a request object (for example, in middleware), and reusing the information elsewhere int he application.

Similarly, this concept is being extended in two places:

1. the application instance, and
2. a transport connection.

#### Application context

A common use case is to attach properties to the app instance. For the sake of consistency, and to avoid the issue of name collision with Sanic properties, the `ctx` object now exists on `Sanic` instances.

```python
@app.before_server_startup
async def startup_db(app, _):
    # WRONG
    app.db = await connect_to_db()

    # CORRECT
    app.ctx.db = await connect_to_db()
```

#### Connection context

When a client sends a keep alive header, Sanic will attempt to keep the transport socket [open for a period of time](../deployment/configuration.md#keep-alive-timeout). That transport object now has a `ctx` object available on it. This effectively means that multiple requests from a single client (where the transport layer is being reused) may share state.

```python
@app.on_request
async def increment_foo(request):
    if not hasattr(request.conn_info.ctx, "foo"):
        request.conn_info.ctx.foo = 0
    request.conn_info.ctx.foo += 1

@app.get("/")
async def count_foo(request):
    return text(f"request.conn_info.ctx.foo={request.conn_info.ctx.foo}")
```

```bash
$ curl localhost:8000 localhost:8000 localhost:8000
request.conn_info.ctx.foo=1
request.conn_info.ctx.foo=2
request.conn_info.ctx.foo=3
```

::: warning
Connection level context is an experimental feature, and should be finalized in v21.6.
:::

## News


### A NEW frontpage ğŸ‰

We have split the documentation into two. The docstrings inside the codebase will still continue to build sphinx docs to ReadTheDocs. However, it will be limited to API documentation. The new frontpage will house the "Sanic User Guide".

The new site runs on Vuepress. Contributions are welcome. We also invite help in translating the documents.

As a part of this, we also freshened up the RTD documentation and changed it to API docs only.

### Chat has moved to Discord

The Gitter chatroom has taken one step closer to being phased out. In its place we opened a [Discord server](https://discord.gg/FARQzAEMAA).

### Open Collective

The Sanic Community Organization has [opened a page on Open Collective](https://opencollective.com/sanic-org) to enable anyone that would like to financially support the development of Sanic.

### 2021 Release Managers

Thank you to @sjsadowski and @yunstanford for acting as release managers for both 2019 and 2020. This year's release managers are @ahopkins and @vltr.

## Thank you

Thank you to everyone that participated in this release: :clap:

[@ahopkins](https://github.com/ahopkins) [@akshgpt7](https://github.com/akshgpt7) [@artcg](https://github.com/artcg) [@ashleysommer](https://github.com/ashleysommer) [@elis-k](https://github.com/elis-k) [@harshanarayana](https://github.com/harshanarayana) [@sjsadowski](https://github.com/sjsadowski) [@tronic](https://github.com/tronic) [@vltr](https://github.com/vltr),

To [@ConnorZhang](https://github.com/miss85246) and [@ZinkLu](https://github.com/ZinkLu) for translating our documents into Chinese,

---

Make sure to checkout the changelog to get links to all the PRs, etc.
