# バージョン22.3

[[toc]]

## 概要

このリリースは、バージョン22の[リリースサイクル](../../org/policies.md#release-schedule)の最初のリリースとなります。 すべての標準SCOライブラリが同じリリースサイクルに入り、同じバージョンのパターンに従います。 パッケージは以下のとおりです:

- [`sanic-routing`](https://github.com/sanic-org/sanic-routing)
- [`sanic-testing`](https://github.com/sanic-org/sanic-testing)
- [`sanic-ext`](https://github.com/sanic-org/sanic-ext)

## 知っておきたいこと

詳しくは[変更履歴](https://sanic.readthedocs.io/en/stable/sanic/changelog.html)をご覧ください。 注目すべき新機能・不具合、アップグレード対象など...

### アプリケーションのマルチサービス

Sanicサーバーには、同じプロセスで複数のアプリケーションを並行して実行できるAPIが追加されました。 これは、1つまたは複数のアプリケーションインスタンスに `app.prepare(...)` を呼び出すことによって行われます。 毎回ユニークなホスト/ポートの組み合わせにバインドする必要があります。 そして、 `Sanic.serve()` を呼び出してアプリケーションに応答します。

```python
app = Sanic("One")
app2 = Sanic("Two")

app.prepare(port=9999)
app.prepare(port=9998)
app.prepare(port=9997)
app2.prepare(port=8888)
app2.prepare(port=8887)

Sanic.serve()
```

上記のスニペットには、同時に実行され、複数のポートにバインドされる2つのアプリケーションがあります。 この機能は CLIではサポートされて*いません*。

このパターンは、 `app.run(...)` を実行する代わりに使用されます。 `app.run` は上記のパターンの省略形であり、まだ完全にサポートされていることに注意してください。

### 👶 *BETA FEATURE* - 新しいパスパラメータタイプ: ファイル拡張子

非常に一般的なパターンは、動的にファイルを生成するルートを作成することです。 エンドポイントは、拡張子のあるファイル上で一致するように意図されています。 ファイルに一致する新しいパスパラメータがあります: `<foo:ext>`.

```python
@app.get("/path/to/<filename:ext>")
async def handler(request, filename, ext):
    ...
```

これはファイル拡張子で終わるパターンをキャッチします。 ただし、拡張子を指定し、ファイル名に他のパスパラメータ型を使用することで、これを展開することができます。

例えば、 `.jpg` のファイルを数字のみでキャッチしたい場合:

```python
@app.get("/path/to/<filename=int:ext=jpg>")
async def handler(request, filename, ext):
    ...
```

可能性のある例:

<table spaces-before="0">
  <tr>
    <th>
      定義
    </th>
    
    <th>
      例
    </th>
    
    <th>
      ファイル名
    </th>
    
    <th>
      拡張子
    </th>
  </tr>
  
  <tr>
    <td>
      \<file:ext>
    </td>
    
    <td>
      page.txt
    </td>
    
    <td>
      <code>"page"</code>
    </td>
    
    <td>
      <code>"txt"</code>
    </td>
  </tr>
  
  <tr>
    <td>
      \<file:ext=jpg>
    </td>
    
    <td>
      cat.jpg
    </td>
    
    <td>
      <code>"cat"</code>
    </td>
    
    <td>
      <code>"jpg"</code>
    </td>
  </tr>
  
  <tr>
    <td>
      \<file:ext=jpg\
    </td>
    
    <td>
      png\
    </td>
    
    <td>
      gif\
    </td>
    
    <td>
      svg>     | cat.jpg     | <code>"cat"</code>     | <code>"jpg"</code>
    </td>
  </tr>
  
  <tr>
    <td>
      <file=int:ext>
    </td>
    
    <td>
      123.txt
    </td>
    
    <td>
      <code>123</code>
    </td>
    
    <td>
      <code>"txt"</code>
    </td>
  </tr>
  
  <tr>
    <td>
      <file=int:ext=jpg\
    </td>
    
    <td>
      png\
    </td>
    
    <td>
      gif\
    </td>
    
    <td>
      svg> | 123.svg     | <code>123</code>       | <code>"svg"</code>
    </td>
  </tr>
  
  <tr>
    <td>
      <file=float:ext=tar.gz>
    </td>
    
    <td>
      3.14.tar.gz
    </td>
    
    <td>
      <code>3.14</code>
    </td>
    
    <td>
      <code>"tar.gz"</code>
    </td>
  </tr>
</table>

### 🚨 *破壊的変更* - パスパラメータの空でない文字列の一致

動的パスパラメータは空でない文字列にのみマッチします。

以前は、動的な文字列パラメータ (`/<foo>` または `/<foo:str>`) を持つルートは、任意の文字列にマッチします。 空の文字列も含めて。 現在では、空でない文字列にのみマッチするようになりました。 古い動作を維持するには、新しいパラメータ type: `/<foo:strorempty>` を使用する必要があります。

```python
@app.get("/path/to/<foo:strorempty>")
async def handler(request, foo)
    ...
```

### 🚨 *破壊的変更* - `sanic.worker.GunicornWorker` が削除されました

非推奨のポリシーからの離脱のため、Sanic サーバをマルチサーブにアップグレードするプロセスの一部として `GunicornWorker` が削除されました。 This decision was made largely in part because even while it existed it was not an optimal strategy for deploying Sanic.

If you want to deploy Sanic using `gunicorn`, then you are advised to do it using [the strategy implemented by `uvicorn`](https://www.uvicorn.org/#running-with-gunicorn). This will effectively run Sanic as an ASGI application through `uvicorn`. You can upgrade to this pattern by installing `uvicorn`:

```
pip install uvicorn
```

Then, you should be able to run it with a pattern like this:

```
gunicorn path.to.sanic:app -k uvicorn.workers.UvicornWorker
```

### Authorization header parsing

The `Authorization` header has been partially parseable for some time now. You have been able to use `request.token` to gain access to a header that was in one of the following two forms:

```
Authorization: Token <SOME TOKEN HERE>
Authorization: Bearer <SOME TOKEN HERE>
```

Sanic can now parse more credential types like `BASIC`:

```
Authorization: Basic Z2lsLWJhdGVzOnBhc3N3b3JkMTIz
```

This can be accessed now as `request.credentials`:

```python
print(request.credentials)
# Credentials(auth_type='Basic', token='Z2lsLWJhdGVzOnBhc3N3b3JkMTIz', _username='gil-bates', _password='password123')
```

### CLI arguments optionally injected into application factory

Sanic will now attempt to inject the parsed CLI arguments into your factory if you are using one.

```python
def create_app(args):
    app = Sanic("MyApp")
    print(args)
    return app
```
```
$sanic p:create_app --factory
Namespace(module='p:create_app', factory=True, simple=False, host='127.0.0.1', port=8000, unix='', cert=None, key=None, tls=None, tlshost=False, workers=1, fast=False, access_log=False, debug=False, auto_reload=False, path=None, dev=False, motd=True, verbosity=None, noisy_exceptions=False)
```

If you are running the CLI with `--factory`, you also have the option of passing arbitrary arguments to the command, which will be injected into the argument `Namespace`.

```
sanic p:create_app --factory --foo=bar
Namespace(module='p:create_app', factory=True, simple=False, host='127.0.0.1', port=8000, unix='', cert=None, key=None, tls=None, tlshost=False, workers=1, fast=False, access_log=False, debug=False, auto_reload=False, path=None, dev=False, motd=True, verbosity=None, noisy_exceptions=False, foo='bar')
```

### New reloader process listener events

When running Sanic server with auto-reload, there are two new events that trigger a listener *only* on the reloader process:

- `reload_process_start`
- `reload_process_stop`

These are only triggered if the reloader is running.

```python
@app.reload_process_start
async def reload_start(*_):
    print(">>>>>> reload_start <<<<<<")


@app.reload_process_stop
async def reload_stop(*_):
    print(">>>>>> reload_stop <<<<<<")
```

### The event loop is no longer a required argument of a listener

You can leave out the `loop` argument of a listener. Both of these examples work as expected:

```python
@app.before_server_start
async def without(app):
    ...

@app.before_server_start
async def with(app, loop):
    ...
```

### Removal - Debug mode does not automatically start the reloader

When running with `--debug` or `debug=True`, the Sanic server will not automatically start the auto-reloader. This feature of doing both on debug was deprecated in v21 and removed in this release. If you would like to have *both* debug mode and auto-reload, you can use `--dev` or `dev=True`.

**dev = debug mode + auto reloader**

### Deprecation - Loading of lower case environment variables

Sanic loads prefixed environment variables as configuration values. It has not distinguished between uppercase and lowercase as long as the prefix matches. However, it has always been the convention that the keys should be uppercase. This is deprecated and you will receive a warning if the value is not uppercase. In v22.9 only uppercase and prefixed keys will be loaded.

## News

### Packt publishes new book on Sanic web development

---:1 There is a new book on **Python Web Development with Sanic** by [@ahopkins](https://github.com/ahopkins). The book is endorsed by the SCO and part of the proceeds of all sales go directly to the SCO for further development of Sanic.

You can learn more at [sanicbook.com](https://sanicbook.com/) :--:1 ![Python Web Development with Sanic](https://sanicbook.com/images/SanicCoverFinal.png) :---

## Thank you

Thank you to everyone that participated in this release: :clap:

[@aericson](https://github.com/aericson) [@ahankinson](https://github.com/ahankinson) [@ahopkins](https://github.com/ahopkins) [@ariebovenberg](https://github.com/ariebovenberg) [@ashleysommer](https://github.com/ashleysommer) [@Bluenix2](https://github.com/Bluenix2) [@ChihweiLHBird](https://github.com/ChihweiLHBird) [@dotlambda](https://github.com/dotlambda) [@eric-spitler](https://github.com/eric-spitler) [@howzitcdf](https://github.com/howzitcdf) [@jonra1993](https://github.com/jonra1993) [@prryplatypus](https://github.com/prryplatypus) [@raphaelauv](https://github.com/raphaelauv) [@SaidBySolo](https://github.com/SaidBySolo) [@SerGeRybakov](https://github.com/SerGeRybakov) [@Tronic](https://github.com/Tronic)


---

If you enjoy the project, please consider contributing. Of course we love code contributions, but we also love contributions in any form. Consider writing some documentation, showing off use cases, joining conversations and making your voice known, and if you are able: [financial contributions](https://opencollective.com/sanic-org/).
