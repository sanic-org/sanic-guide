# バージョン21.9

[[toc]]

## 概要

これはバージョン21の3つ目の[リリースサイクル](../../org/policies.md#release-schedule)です。 バージョン21は、12月の長期サポート版リリースで「確定」する予定です。 

## 知っておきたい

詳しくは[Changelog](https://sanic.readthedocs.io/en/stable/sanic/changelog.html)をご覧ください。注目すべき新機能・不具合、アップグレード対象など...

### 設定値の削除: `WEBSOCKET_READ_LIMIT`、`WEBSOCKET_WRITE_LIMIT`、`WEBSOCKET_MAX_QUEUE`

ウェブソケット実装の全面的な見直しに伴い、これらの設定値は削除されました。現在、これらを置き換える予定はありません。

### `FALLBACK_ERROR_FORMAT`のデフォルト値の非推奨

エラーハンドラが添付されていない場合、Sanicはフォールバックのフォーマットタイプとして`html`を使用してきました。これは非推奨となり、v22.3から`text`に変更される予定です。この値は `auto` に変更されましたが、変更前の v21.12LTS までは、最後の手段として HTML を使用し続けるでしょう。

### `ErrorHandler.lookup`署名の非推奨

`ErrorHandler.lookup`は今、2つの位置専用引数を**必須**にしています:

```python
def lookup(self, exception, route_name: Optional[str]):
```

不適合なメソッドを使用すると、Blueprint 固有の例外ハンドラが適切にアタッチされない原因となります。

### 今後の機能削除のお知らせ

注意点として、以下の項目はすでに非推奨となっており、バージョン21.12LTSで削除される予定です。

- `CompositionView`
- `load_env` (代わりに `env_prefix` を使用)
- サニックオブジェクト（アプリケーションインスタンス、ブループリント、ルート）は、以下に準拠した英数字を使用する必要があります。`^[a-zA-Z][a-zA-Z0-9_\-]*$`
- アプリケーションとブループリントのインスタンスへのオブジェクトの任意の割り当て (代わりに `ctx` を使用します。この削除は 21.9 から 21.12 にバンプされました)

### ウェブソケットの全面見直し

ウェブソケット接続の取り扱いについて、大きな見直しが行われました。[@augustin](https://github.com/aaugustin) のおかげで、[`websockets`](https://websockets.readthedocs.io/en/stable/index.html) に新しい実装が追加され、Sanic が自分自身でウェブソケット接続の I/O を処理することができるようになりました。そのため、Sanicは最小バージョンを `websockets>=10.0` に引き上げました。

この変更は、Sanicのウェブソケットハンドラに関するいくつかの奇妙な点が修正されたことを除けば、開発者にはほとんど気づかれないはずです。例えば、誰かが切断したときに `CancellError` を自分で捕らえることができるようになったはずです。

```python
@app.websocket("/")
async def handler(request, ws):
    try:
        while True:
            await asyncio.sleep(0.25)
    except asyncio.CancelledError:
        print("User closed connection")
```

### ビルトイン信号

バージョン [21.3](./v21.3.md) で [signals](../advanced/signals.md) が導入されました。現在、Sanicは**コードベース自体から**シグナルイベントをディスパッチします。これは、開発者が以前よりもはるかに近いレベルでリクエスト/レスポンスサイクルにフックする能力を持っていることを意味します。

これまでは、何らかのロジックを注入しようとすると、ミドルウェアに限られていたのです。統合シグナルは「スーパーミドルウェア」だと考えてください。現在ディスパッチされるイベントは以下の通りです。

- `http.lifecycle.begin`
- `http.lifecycle.complete`
- `http.lifecycle.exception`
- `http.lifecycle.handle`
- `http.lifecycle.read_body`
- `http.lifecycle.read_head`
- `http.lifecycle.request`
- `http.lifecycle.response`
- `http.lifecycle.send`
- `http.middleware.after`
- `http.middleware.before`
- `http.routing.after`
- `http.routing.before`
- `server.init.after`
- `server.init.before`
- `server.shutdown.after`
- `server.shutdown.before`

::: tip Note
`server`シグナルは、4つのメインサーバリスナーイベントと同じです。実際、これらのリスナーはシグナルを実装するための便利なラッパーに過ぎません。
:::

### より賢い`自動`例外フォーマット

Sanicは現在、エンドポイントとクライアントに基づいた適切な例外フォーマットで応答しようとします。たとえば、エンドポイントが常に `sanic.response.json` オブジェクトを返す場合、例外はすべて自動的に JSON でフォーマットされます。同じことが、 `text` と `html` のレスポンスにも当てはまります。

さらに、ルート定義により、ルートごとに使用するフォーマッターを_明示的に_制御できるようになりました。

```python
@app.route("/", error_format="json")
async def handler(request):
    pass
```

### ブループリントのコピー

ブループリントは、新しいインスタンスにコピーすることができます。これは、ルートやミドルウェアなど、それに付随するすべてのものを引き継ぎます。

```python
v1 = Blueprint("Version1", version=1)

@v1.route("/something")
def something(request):
    pass

v2 = v1.copy("Version2", version=2)

app.blueprint(v1)
app.blueprint(v2)
```

```
/v1/something
/v2/something
```
### ブループリントグループの便利なメソッド

ブループリントグループは、通常のブループリントと同じすべてのメソッドを使用できるようになりました。これにより、ブループリントのコピーと合わせて、ブループリントは非常にコンポーザブルで柔軟なものになるはずです。

### Acceptヘッダーの解析

Sanicの`Request`オブジェクトは `Accept` ヘッダーをパースして、クライアントの content-type の優先順位のリストを提供することができます。単純にアクセッサとしてアクセスすることができます。

```python
print(request.accept)
# ["*/*"]
```

また、ワイルドカードでの照合も可能です。例えば、受信したリクエストに含まれるものとして:

```
Accept: */*
```

その場合、以下は `True` となります。

```python
"text/plain" in request.accept
```

### デフォルトの例外メッセージ

`SanicException` から派生した例外はすべて、デフォルトの例外メッセージを定義できるようになりました。これにより、複数の場所で同じ例外を再利用する際に、例外が提供するメッセージに関するDRY問題が発生しなくなり、より便利で保守しやすくなりました。

```python
class TeaError(SanicException):
    message = "Tempest in a teapot"


raise TeaError
```

### 型アノテーションの利便機能

Pythonの型アノテーションを利用して、パスパラメータの型を制御することが可能になりました。次のようにする代わりに、

```python
@app.route("/<one:int>/<two:float>/<three:uuid>")
def handler(request: Request, one: int, two: float, three: UUID):
    ...
```

次のようにシンプルにできるようになりました。

```python
@app.route("/<one>/<two>/<three>")
def handler(request: Request, one: int, two: float, three: UUID):
    ...
```

これらの例では、どちらも同じルーティングの原則が適用されることになります。

### 明示的な静的リソース型

静的なエンドポイントに、リソースをファイルとして扱うかディレクトリとして扱うかを明示的に指示できるようになりました。

```python
static("/", "/path/to/some/file", resource_type="file"))
```

## ニュース

### Release of `sanic-ext` and deprecation of `sanic-openapi`

One of the core principles of Sanic is that it is meant to be a tool, not a dictator. As the frontpage of this website states:

> Build the way you want to build without letting your tooling constrain you.

This means that a lot of common features used (specifically by Web API developers) do not exist in the `sanic` repository. This is for good reason. Being unopinionated provides the developer freedom and flexibility.

But, sometimes you do not want to have to build and rebuild the same things. Sanic has until now really relied upon the awesome support of the community to fill in the gaps with plugins.

From the early days, there has been an official `sanic-openapi` package that offered the ability to create OpenAPI documentation based upon your application. But, that project has been plagued over the years and has not been given as much priority as the main project.

Starting with the release of v21.9, the SCO is deprecating the `sanic-openapi` package and moving it to maintenance mode. This means that it will continue to get updates as needed to maintain it for the current future, but it will not receive any new feature enhancements.

A new project called `sanic-ext` is taking its place. This package provides not only the ability to build OAS3 documentation, but fills in many of the gaps that API developers may want in their applications. For example, out of the box it will setup CORS, and auto enable `HEAD` and `OPTIONS` responses where needed. It also has the ability validate incoming data using either standard library Dataclasses or Pydantic models.

The list of goodies includes:
- CORS protection
- incoming request validation
- auto OAS3 documentation using Redoc and/or Swagger UI
- auto `HEAD`, `OPTIONS`, and `TRACE` responses
- dependency injection
- response serialization

This project is still in `alpha` mode for now and is subject to change. While it is considered to be production capable, there may be some need to change the API as we continue to add features.

Checkout the [documentation](../../plugins/sanic-ext/getting-started.md) for more details.


## Thank you

Thank you to everyone that participated in this release: :clap:

[@aaugustin](https://github.com/aaugustin)
[@ahopkins](https://github.com/ahopkins)
[@ashleysommer](https://github.com/ashleysommer)
[@cansarigol3megawatt](https://github.com/cansarigol3megawatt)
[@ChihweiLHBird](https://github.com/ChihweiLHBird)
[@gluhar2006](https://github.com/gluhar2006)
[@komar007](https://github.com/komar007)
[@ombe1229](https://github.com/ombe1229)
[@prryplatypus](https://github.com/prryplatypus)
[@SaidBySolo](https://github.com/SaidBySolo)
[@Tronic](https://github.com/tronic)
[@vltr](https://github.com/vltr)

And, a special thank you to [@miss85246](https://github.com/miss85246) and [@ZinkLu](https://github.com/ZinkLu) for their tremendous work keeping the documentation synced and translated into Chinese.

---

If you enjoy the project, please consider contributing. Of course we love code contributions, but we also love contributions in any form. Consider writing some documentation, showing off use cases, joining conversations and making your voice known, and if you are able, [financial contributions](https://opencollective.com/sanic-org/).
